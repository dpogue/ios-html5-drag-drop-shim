{"version":3,"file":"drag-drop-polyfill-scroll-behaviour.js","sources":["../src/drag-drop-polyfill.ts","../src/drag-drop-polyfill-scroll-behaviour.ts"],"sourcesContent":["// debug mode, which will highlight drop target, immediate user selection and events fired as you interact.\nlet DEBUG:boolean;\n\n\n//TODO temporary definition of new event listener signature, should be in lib.d.ts\n// See https://github.com/Microsoft/TypeScript/issues/9548\n\ninterface WhatWGEventListenerArgs {\n    capture?: boolean;\n}\n\ninterface WhatWGAddEventListenerArgs extends WhatWGEventListenerArgs {\n    passive?: boolean;\n    once?: boolean;\n}\n\ntype WhatWGAddEventListener = (\n    type: string,\n    listener: (event:Event) => void,\n    options?: WhatWGAddEventListenerArgs\n) => void;\n\n\n//<editor-fold desc=\"feature detection\">\n\ninterface DetectedFeatures {\n    draggable:boolean;\n    dragEvents:boolean;\n    touchEvents:boolean;\n    userAgentSupportingNativeDnD:boolean;\n}\n\nfunction detectFeatures():DetectedFeatures {\n\n    let features:DetectedFeatures = {\n        dragEvents: (\"ondragstart\" in document.documentElement),\n        draggable: (\"draggable\" in document.documentElement),\n        touchEvents: (\"ontouchstart\" in document.documentElement),\n        userAgentSupportingNativeDnD: undefined\n    };\n\n    const isBlinkEngine = !!((<any>window).chrome) || /chrome/i.test( navigator.userAgent );\n\n    features.userAgentSupportingNativeDnD = !(\n        // if is mobile safari or android browser -> no native dnd\n        (/iPad|iPhone|iPod|Android/.test( navigator.userAgent ))\n        || // OR\n        //if is blink(chrome/opera) with touch events enabled -> no native dnd\n        (isBlinkEngine && features.touchEvents)\n    );\n\n    if( DEBUG ) {\n        Object.keys( features ).forEach( function( key ) {\n            console.log( \"dnd-poly: detected feature '\" + key + \" = \" + features[ key ] + \"'\" );\n        } );\n    }\n\n    return features;\n}\n\nlet supportsPassive:boolean;\n\nfunction supportsPassiveEventListener():boolean {\n\n    let supportsPassiveEventListeners = false;\n\n    // reference https://github.com/WICG/EventListenerOptions/blob/gh-pages/explainer.md\n    try {\n        let opts = Object.defineProperty({}, \"passive\", {\n            get: function() {\n                supportsPassiveEventListeners = true;\n            }\n        });\n        window.addEventListener(\"test\", null, opts);\n    }\n    // tslint:disable-next-line:no-empty\n    catch (e) {}\n\n    return supportsPassiveEventListeners;\n}\n\n//</editor-fold>\n\n//<editor-fold desc=\"public api\">\n\n// function signature for the dragImageTranslateOverride hook\nexport type DragImageTranslateOverrideFn = (\n    // corresponding touchmove event\n    event:TouchEvent,\n    // the processed touch event viewport coordinates\n    hoverCoordinates:Point,\n    // the element under the calculated touch coordinates\n    hoveredElement:HTMLElement,\n    // callback for updating the drag image offset\n    translateDragImageFn:( offsetX:number, offsetY:number ) => void\n) => void;\n\nexport interface Config {\n    // flag to force the polyfill being applied and not rely on internal feature detection\n    forceApply?:boolean;\n    // useful for when you want the default drag image but still want to apply\n    // some static offset from touch coordinates to drag image coordinates\n    // defaults to (0,0)\n    dragImageOffset?:Point;\n    // if the dragImage shall be centered on the touch coordinates\n    // defaults to false\n    dragImageCenterOnTouch?:boolean;\n    // the drag and drop operation involves some processing. here you can specify in what interval this processing takes place.\n    // defaults to 150ms\n    iterationInterval?:number;\n    // hook for custom logic that decides if a drag operation should start\n    dragStartConditionOverride?:( event:TouchEvent ) => boolean;\n    // hook for custom logic that can manipulate the drag image translate offset\n    dragImageTranslateOverride?:DragImageTranslateOverrideFn;\n    // hook for custom logic that can override the default action based on the original touch event when the drag never started\n    // be sure to call event.preventDefault() if handling the default action in the override to prevent the browser default.\n    defaultActionOverride?:( event:TouchEvent ) => void;\n}\n\n// default config\nconst config:Config = {\n    iterationInterval: 150,\n};\n\nfunction Initialize( override?:Config ) {\n\n    if( override ) {\n        // overwrite default config with user config\n        Object.keys( override ).forEach( function( key ) {\n            config[ key ] = override[ key ];\n        } );\n    }\n\n    // only do feature detection when config does not force apply the polyfill\n    if( !config.forceApply ) {\n\n        // feature/browser detection\n        const detectedFeatures = detectFeatures();\n\n        // check if native drag and drop support is there\n        if( detectedFeatures.userAgentSupportingNativeDnD\n            && detectedFeatures.draggable\n            && detectedFeatures.dragEvents ) {\n            // no polyfilling required\n            return;\n        }\n    }\n\n    console.log( \"dnd-poly: Applying mobile drag and drop polyfill.\" );\n\n    supportsPassive = supportsPassiveEventListener();\n\n    // add listeners suitable for detecting a potential drag operation\n    addDocumentListener( \"touchstart\", onTouchstart, false );\n}\n\n//</editor-fold>\n\n//<editor-fold desc=\"drag operation start/end\">\n\n// reference the currently active drag operation\nlet activeDragOperation:DragOperationController;\n\n/**\n * event handler listening for initial events that possibly start a drag and drop operation.\n */\nfunction onTouchstart( e:TouchEvent ) {\n\n    DEBUG && console.log( \"dnd-poly: global touchstart\" );\n\n    // From the moment that the user agent is to initiate the drag-and-drop operation,\n    // until the end of the drag-and-drop operation, device input events (e.g. mouse and keyboard events) must be suppressed.\n\n    // only allow one drag operation at a time\n    if( activeDragOperation ) {\n        DEBUG && console.log( \"dnd-poly: drag operation already active\" );\n        return;\n    }\n\n    let dragTarget = tryFindDraggableTarget( e );\n\n    // If there is no such element, then nothing is being dragged; abort these\n    // steps, the drag-and-drop operation is never started.\n    if( !dragTarget ) {\n        return;\n    }\n\n    try {\n        activeDragOperation = new DragOperationController( e, config, <HTMLElement>dragTarget, dragOperationEnded );\n    }\n    catch( err ) {\n        dragOperationEnded( config, e, DragOperationState.CANCELLED );\n        // rethrow exception after cleanup\n        throw err;\n    }\n}\n\n/**\n * Search for a possible draggable item upon an event that can initialize a drag operation.\n */\nfunction tryFindDraggableTarget( event:TouchEvent ):Element {\n\n    //1. Determine what is being dragged, as follows:\n\n    // THIS IS SKIPPED SINCE SUPPORT IS ONLY AVAILABLE FOR DOM ELEMENTS\n    // If the drag operation was invoked on a selection, then it is the selection that is being dragged.\n    //if( (<Element>event.target).nodeType === 3 ) {\n    //\n    //    config.log( \"drag on text\" );\n    //    return <Element>event.target;\n    //}\n    //Otherwise, if the drag operation was invoked on a Document, it is the first element, going up the ancestor chain, starting at the node that the\n    // user tried to drag, that has the IDL attribute draggable set to true.\n    //else {\n\n    let el = <HTMLElement>event.target;\n\n    do {\n        if( el.draggable === false ) {\n            continue;\n        }\n        if( el.getAttribute && el.getAttribute( \"draggable\" ) === \"true\" ) {\n            return el;\n        }\n    } while( (el = <HTMLElement>el.parentNode) && el !== document.body );\n}\n\n/**\n * Implements callback invoked when a drag operation has ended or crashed.\n */\nfunction dragOperationEnded( _config:Config, event:TouchEvent, state:DragOperationState ) {\n\n    // we need to make the default action happen only when no drag operation took place\n    if( state === DragOperationState.POTENTIAL ) {\n\n        DEBUG && console.log( \"dnd-poly: Drag never started. Last event was \" + event.type );\n\n        // when lifecycle hook is present\n        if( _config.defaultActionOverride ) {\n\n            try {\n\n                _config.defaultActionOverride( event );\n\n                if( event.defaultPrevented ) {\n\n                    DEBUG && console.log( \"dnd-poly: defaultActionOverride has taken care of triggering the default action. preventing default on original event\" );\n                }\n\n            }\n            catch( e ) {\n\n                DEBUG && console.log( \"dnd-poly: error in defaultActionOverride: \" + e );\n            }\n        }\n    }\n\n    // reset drag operation container\n    activeDragOperation = null;\n}\n\n//</editor-fold>\n\n//<editor-fold desc=\"drag operation\">\n\n/**\n * For tracking the different states of a drag operation.\n */\nconst enum DragOperationState {\n    // initial state of a controller, if no movement is detected the operation ends with this state\n    POTENTIAL,\n    // after movement is detected the drag operation starts and keeps this state until it ends\n    STARTED,\n    // when the drag operation ended normally\n    ENDED,\n    // when the drag operation ended with a cancelled input event\n    CANCELLED\n}\n\n// contains all possible values of the effectAllowed property\nconst enum EFFECT_ALLOWED {\n    NONE      = 0,\n    COPY      = 1,\n    COPY_LINK = 2,\n    COPY_MOVE = 3,\n    LINK      = 4,\n    LINK_MOVE = 5,\n    MOVE      = 6,\n    ALL       = 7\n}\nconst ALLOWED_EFFECTS = [ \"none\", \"copy\", \"copyLink\", \"copyMove\", \"link\", \"linkMove\", \"move\", \"all\" ];\n// contains all possible values of the dropEffect property\nconst enum DROP_EFFECT {\n    NONE = 0,\n    COPY = 1,\n    MOVE = 2,\n    LINK = 3,\n}\nconst DROP_EFFECTS = [ \"none\", \"copy\", \"move\", \"link\" ];\n\n// cross-browser css transform property prefixes\nconst TRANSFORM_CSS_VENDOR_PREFIXES = [ \"\", \"-webkit-\" ];\n// css classes\nconst CLASS_PREFIX = \"dnd-poly-\";\nconst CLASS_DRAG_IMAGE = CLASS_PREFIX + \"drag-image\";\nconst CLASS_DRAG_IMAGE_SNAPBACK = CLASS_PREFIX + \"snapback\";\nconst CLASS_DRAG_OPERATION_ICON = CLASS_PREFIX + \"icon\";\n\n/**\n * Aims to implement the HTML5 d'n'd spec (https://html.spec.whatwg.org/multipage/interaction.html#dnd) as close as it can get.\n * Note that all props that are private should start with an underscore to enable better minification.\n *\n * TODO remove lengthy spec comments in favor of short references to the spec\n */\nclass DragOperationController {\n\n    private _dragOperationState:DragOperationState = DragOperationState.POTENTIAL;\n\n    private _dragImage:HTMLElement;\n    private _dragImageTransforms:string[];\n    private _dragImagePageCoordinates:Point; // the current page coordinates of the dragImage\n    private _dragImageOffset:Point; // offset of the drag image relative to the coordinates\n\n    private _currentHotspotCoordinates:Point;    // the point relative to viewport for determining the immediate user selection\n\n    private _immediateUserSelection:HTMLElement = null;  // the element the user currently hovers while dragging\n    private _currentDropTarget:HTMLElement = null;   // the element that was selected as a valid drop target by the d'n'd operation\n\n    private _dragDataStore:DragDataStore;\n    private _dataTransfer:DataTransfer;\n\n    private _currentDragOperation:string;    // the current drag operation set according to the d'n'd processing model\n\n    private _initialTouch:Touch;  // the identifier for the touch that initiated the drag operation\n    private _touchMoveHandler:EventListener;\n    private _touchEndOrCancelHandler:EventListener;\n    private _lastTouchEvent:TouchEvent;\n\n    private _iterationLock:boolean;\n    private _iterationIntervalId:number;\n\n    constructor( private _initialEvent:TouchEvent,\n                 private _config:Config,\n                 private _sourceNode:HTMLElement,\n                 private _dragOperationEndedCb:( config:Config, event:TouchEvent, state:DragOperationState ) => void ) {\n\n        DEBUG && console.log( \"dnd-poly: setting up potential drag operation..\" );\n\n        this._lastTouchEvent = _initialEvent;\n        this._initialTouch = _initialEvent.changedTouches[ 0 ];\n\n        // create bound event listeners\n        this._touchMoveHandler = this._onTouchMove.bind( this );\n        this._touchEndOrCancelHandler = this._onTouchEndOrCancel.bind( this );\n        addDocumentListener( \"touchmove\", this._touchMoveHandler, false );\n        addDocumentListener( \"touchend\", this._touchEndOrCancelHandler, false );\n        addDocumentListener( \"touchcancel\", this._touchEndOrCancelHandler, false );\n\n        // the only thing we do is setup the touch listeners. if drag will really start is decided in touch move handler.\n\n        //<spec>\n\n        // THIS IS SKIPPED SINCE SUPPORT IS ONLY AVAILABLE FOR DOM ELEMENTS\n        // 3. Establish which DOM node is the source node, as follows:\n        // If it is a selection that is being dragged, then the source node is the text node that the user started the drag on (typically the text node\n        // that the user originally clicked). If the user did not specify a particular node, for example if the user just told the user agent to begin\n        // a drag of \"the selection\", then the source node is the first text node containing a part of the selection.  Otherwise, if it is an element\n        // that is being dragged, then the source node is the element that is being dragged.  Otherwise, the source node is part of another document or\n        // application. When this specification requires that an event be dispatched at the source node in this case, the user agent must instead\n        // follow the platform-specific conventions relevant to that situation.\n\n        // THIS IS SKIPPED SINCE SUPPORT IS ONLY AVAILABLE FOR DOM ELEMENTS\n        // 4. Determine the list of dragged nodes, as follows:\n\n        //    If it is a selection that is being dragged, then the list of dragged nodes contains, in tree order, every node that is partially or\n        // completely included in the selection (including all their ancestors).\n\n        //    Otherwise, the list of dragged nodes contains only the source node, if any.\n\n        // THIS IS SKIPPED SINCE SUPPORT IS ONLY AVAILABLE FOR DOM ELEMENTS\n        // 5. If it is a selection that is being dragged, then add an item to the drag data store item list, with its properties set as follows:\n\n        //The drag data item type string\n        //\"text/plain\"\n        //The drag data item kind\n        //Plain Unicode string\n        //The actual data\n        //The text of the selection\n        //Otherwise, if any files are being dragged, then add one item per file to the drag data store item list, with their properties set as follows:\n        //\n        //The drag data item type string\n        //The MIME type of the file, if known, or \"application/octet-stream\" otherwise.\n        //    The drag data item kind\n        //File\n        //The actual data\n        //The file's contents and name.\n        //Dragging files can currently only happen from outside a browsing context, for example from a file system manager application.\n        //\n        //    If the drag initiated outside of the application, the user agent must add items to the drag data store item list as appropriate for the data\n        // being dragged, honoring platform conventions where appropriate; however, if the platform conventions do not use MIME types to label dragged\n        // data, the user agent must make a best-effort attempt to map the types to MIME types, and, in any case, all the drag data item type strings must\n        // be converted to ASCII lowercase.  Perform drag-and-drop initialization steps defined in any other applicable specifications.\n\n        //</spec>\n    }\n\n    //<editor-fold desc=\"setup/teardown\">\n\n    /**\n     * Setup dragImage, input listeners and the drag\n     * and drop process model iteration interval.\n     */\n    private _setup():boolean {\n        DEBUG && console.log( \"dnd-poly: starting drag and drop operation\" );\n\n        this._dragOperationState = DragOperationState.STARTED;\n\n        this._currentDragOperation = DROP_EFFECTS[ DROP_EFFECT.NONE ];\n\n        this._dragDataStore = {\n            _data: {},\n            _effectAllowed: undefined,\n            _mode: DragDataStoreMode.PROTECTED,\n            _types: [],\n        };\n\n        this._currentHotspotCoordinates = {\n            x: null,\n            y: null\n        };\n\n        this._dragImagePageCoordinates = {\n            x: null,\n            y: null\n        };\n\n        let dragImageSrc:HTMLElement = this._sourceNode;\n\n        this._dataTransfer = new DataTransfer( this._dragDataStore, ( element:HTMLElement, x:number, y:number ) => {\n\n            dragImageSrc = element;\n\n            if( typeof x === \"number\" || typeof y === \"number\" ) {\n                this._dragImageOffset = {\n                    x: x || 0,\n                    y: y || 0\n                };\n            }\n        } );\n\n        // 9. Fire a DND event named dragstart at the source node.\n        this._dragDataStore._mode = DragDataStoreMode.READWRITE;\n        this._dataTransfer.dropEffect = DROP_EFFECTS[ DROP_EFFECT.NONE ];\n        if( dispatchDragEvent( \"dragstart\", this._sourceNode, this._lastTouchEvent, this._dragDataStore, this._dataTransfer ) ) {\n            DEBUG && console.log( \"dnd-poly: dragstart cancelled\" );\n            // dragstart has been prevented -> cancel d'n'd\n            this._dragOperationState = DragOperationState.CANCELLED;\n            this._cleanup();\n            return false;\n        }\n\n        updateCentroidCoordinatesOfTouchesIn( \"page\", this._lastTouchEvent, this._dragImagePageCoordinates );\n        this._dragImage = createDragImage( dragImageSrc );\n        this._dragImageTransforms = extractTransformStyles( this._dragImage );\n\n        if( !this._dragImageOffset ) {\n\n            // apply specific offset\n            if( this._config.dragImageOffset ) {\n\n                this._dragImageOffset = {\n                    x: this._config.dragImageOffset.x,\n                    y: this._config.dragImageOffset.y\n                };\n            }\n            // center drag image on touch coordinates\n            else if( this._config.dragImageCenterOnTouch ) {\n\n                const cs = getComputedStyle( dragImageSrc );\n                this._dragImageOffset = {\n                    x: 0 - parseInt( cs.marginLeft, 10 ),\n                    y: 0 - parseInt( cs.marginTop, 10 )\n                };\n            }\n            // by default initialize drag image offset the same as desktop\n            else {\n\n                const targetRect = dragImageSrc.getBoundingClientRect();\n                const cs = getComputedStyle( dragImageSrc );\n                this._dragImageOffset = {\n                    x: targetRect.left - this._initialTouch.clientX - parseInt( cs.marginLeft, 10 ) + targetRect.width / 2,\n                    y: targetRect.top - this._initialTouch.clientY - parseInt( cs.marginTop, 10 ) + targetRect.height / 2\n                };\n            }\n        }\n\n        translateDragImage( this._dragImage, this._dragImagePageCoordinates, this._dragImageTransforms, this._dragImageOffset, this._config.dragImageCenterOnTouch );\n        document.body.appendChild( this._dragImage );\n\n        // 10. Initiate the drag-and-drop operation in a manner consistent with platform conventions, and as described below.\n        this._iterationIntervalId = setInterval( () => {\n\n            // If the user agent is still performing the previous iteration of the sequence (if any) when the next iteration becomes due,\n            // abort these steps for this iteration (effectively \"skipping missed frames\" of the drag-and-drop operation).\n            if( this._iterationLock ) {\n                DEBUG && console.log( \"dnd-poly: iteration skipped because previous iteration hast not yet finished.\" );\n                return;\n            }\n            this._iterationLock = true;\n\n            this._dragAndDropProcessModelIteration();\n\n            this._iterationLock = false;\n        }, this._config.iterationInterval );\n\n        return true;\n    }\n\n    private _cleanup() {\n\n        DEBUG && console.log( \"dnd-poly: cleanup\" );\n\n        if( this._iterationIntervalId ) {\n            clearInterval( this._iterationIntervalId );\n            this._iterationIntervalId = null;\n        }\n\n        removeDocumentListener( \"touchmove\", this._touchMoveHandler );\n        removeDocumentListener( \"touchend\", this._touchEndOrCancelHandler );\n        removeDocumentListener( \"touchcancel\", this._touchEndOrCancelHandler );\n\n        if( this._dragImage ) {\n            this._dragImage.parentNode.removeChild( this._dragImage );\n            this._dragImage = null;\n        }\n\n        this._dragOperationEndedCb( this._config, this._lastTouchEvent, this._dragOperationState );\n    }\n\n    //</editor-fold>\n\n    //<editor-fold desc=\"touch handlers\">\n\n    private _onTouchMove( event:TouchEvent ) {\n\n        // filter unrelated touches\n        if( isTouchIdentifierContainedInTouchEvent( event, this._initialTouch.identifier ) === false ) {\n            return;\n        }\n\n        // update the reference to the last received touch event\n        this._lastTouchEvent = event;\n\n        // drag operation did not start yet but on movement it should start\n        if( this._dragOperationState === DragOperationState.POTENTIAL ) {\n\n            let startDrag:boolean;\n\n            // is a lifecycle hook present?\n            if( this._config.dragStartConditionOverride ) {\n\n                try {\n                    startDrag = this._config.dragStartConditionOverride( event );\n                }\n                catch( e ) {\n                    console.error( \"dnd-poly: error in dragStartConditionOverride hook: \" + e );\n                    startDrag = false;\n                }\n            }\n            else {\n\n                // by default only allow a single moving finger to initiate a drag operation\n                startDrag = (event.touches.length === 1);\n            }\n\n            if( !startDrag ) {\n\n                this._cleanup();\n                return;\n            }\n\n            // setup will return true when drag operation starts\n            if( this._setup() === true ) {\n\n                // prevent scrolling when drag operation starts\n                this._initialEvent.preventDefault();\n                event.preventDefault();\n            }\n\n            return;\n        }\n\n        DEBUG && console.log( \"dnd-poly: moving draggable..\" );\n\n        // we emulate d'n'd so we dont want any defaults to apply\n        event.preventDefault();\n\n        // populate shared coordinates from touch event\n        updateCentroidCoordinatesOfTouchesIn( \"client\", event, this._currentHotspotCoordinates );\n        updateCentroidCoordinatesOfTouchesIn( \"page\", event, this._dragImagePageCoordinates );\n\n        if( this._config.dragImageTranslateOverride ) {\n\n            try {\n\n                let handledDragImageTranslate = false;\n\n                this._config.dragImageTranslateOverride(\n                    event,\n                    {\n                        x: this._currentHotspotCoordinates.x,\n                        y: this._currentHotspotCoordinates.y\n                    },\n                    this._immediateUserSelection,\n                    ( offsetX:number, offsetY:number ) => {\n\n                        // preventing translation of drag image when there was a drag operation cleanup meanwhile\n                        if( !this._dragImage ) {\n                            return;\n                        }\n\n                        handledDragImageTranslate = true;\n\n                        this._currentHotspotCoordinates.x += offsetX;\n                        this._currentHotspotCoordinates.y += offsetY;\n                        this._dragImagePageCoordinates.x += offsetX;\n                        this._dragImagePageCoordinates.y += offsetY;\n\n                        translateDragImage(\n                            this._dragImage,\n                            this._dragImagePageCoordinates,\n                            this._dragImageTransforms,\n                            this._dragImageOffset,\n                            this._config.dragImageCenterOnTouch\n                        );\n                    }\n                );\n\n                if( handledDragImageTranslate ) {\n                    return;\n                }\n            }\n            catch( e ) {\n                DEBUG && console.log( \"dnd-poly: error in dragImageTranslateOverride hook: \" + e );\n            }\n        }\n\n        translateDragImage( this._dragImage, this._dragImagePageCoordinates, this._dragImageTransforms, this._dragImageOffset, this._config.dragImageCenterOnTouch );\n    }\n\n    private _onTouchEndOrCancel( event:TouchEvent ) {\n\n        // filter unrelated touches\n        if( isTouchIdentifierContainedInTouchEvent( event, this._initialTouch.identifier ) === false ) {\n            return;\n        }\n\n        // let the dragImageTranslateOverride know that its over\n        if( this._config.dragImageTranslateOverride ) {\n            try {\n                /* tslint:disable */\n                this._config.dragImageTranslateOverride( undefined, undefined, undefined, function() {\n                } );\n            }\n            catch( e ) {\n                DEBUG && console.log( \"dnd-poly: error in dragImageTranslateOverride hook: \" + e );\n            }\n        }\n\n        // drag operation did not even start\n        if( this._dragOperationState === DragOperationState.POTENTIAL ) {\n            this._cleanup();\n            return;\n        }\n\n        // we emulate d'n'd so we dont want any defaults to apply\n        event.preventDefault();\n\n        this._dragOperationState = (event.type === \"touchcancel\") ? DragOperationState.CANCELLED : DragOperationState.ENDED;\n    }\n\n    //</editor-fold>\n\n    //<editor-fold desc=\"dnd spec logic\">\n\n    /**\n     * according to https://html.spec.whatwg.org/multipage/interaction.html#drag-and-drop-processing-model\n     */\n    private _dragAndDropProcessModelIteration():void {\n\n        if( DEBUG ) {\n            var debug_class                = CLASS_PREFIX + \"debug\",\n                debug_class_user_selection = CLASS_PREFIX + \"immediate-user-selection\",\n                debug_class_drop_target    = CLASS_PREFIX + \"current-drop-target\";\n        }\n\n        const previousDragOperation = this._currentDragOperation;\n\n        // Fire a DND event named drag event at the source node.\n        this._dragDataStore._mode = DragDataStoreMode.PROTECTED;\n        this._dataTransfer.dropEffect = DROP_EFFECTS[ DROP_EFFECT.NONE ];\n        const dragCancelled = dispatchDragEvent( \"drag\", this._sourceNode, this._lastTouchEvent, this._dragDataStore, this._dataTransfer );\n        if( dragCancelled ) {\n            DEBUG && console.log( \"dnd-poly: drag event cancelled.\" );\n            // If this event is canceled, the user agent must set the current drag operation to \"none\" (no drag operation).\n            this._currentDragOperation = DROP_EFFECTS[ DROP_EFFECT.NONE ];\n        }\n\n        // Otherwise, if the user ended the drag-and-drop operation (e.g. by releasing the mouse button in a mouse-driven drag-and-drop interface),\n        // or if the drag event was canceled, then this will be the last iteration.\n        if( dragCancelled || this._dragOperationState === DragOperationState.ENDED || this._dragOperationState === DragOperationState.CANCELLED ) {\n\n            const dragFailed = this._dragOperationEnded( this._dragOperationState );\n\n            // if drag failed transition snap back\n            if( dragFailed ) {\n\n                applyDragImageSnapback( this._sourceNode, this._dragImage, this._dragImageTransforms, () => {\n                    this._finishDragOperation();\n                } );\n                return;\n            }\n\n            // Otherwise immediately\n            // Fire a DND event named dragend at the source node.\n            this._finishDragOperation();\n            return;\n        }\n\n        // If the drag event was not canceled and the user has not ended the drag-and-drop operation,\n        // check the state of the drag-and-drop operation, as follows:\n        const newUserSelection:HTMLElement = <HTMLElement>document.elementFromPoint( this._currentHotspotCoordinates.x, this._currentHotspotCoordinates.y );\n\n        DEBUG && console.log( \"dnd-poly: new immediate user selection is: \" + newUserSelection );\n\n        const previousTargetElement = this._currentDropTarget;\n\n        // If the user is indicating a different immediate user selection than during the last iteration (or if this is the first iteration),\n        // and if this immediate user selection is not the same as the current target element,\n        // then fire a DND event named dragexit at the current target element,\n        // and then update the current target element as follows:\n        if( newUserSelection !== this._immediateUserSelection && newUserSelection !== this._currentDropTarget ) {\n\n            if( DEBUG ) {\n\n                if( this._immediateUserSelection ) {\n                    this._immediateUserSelection.classList.remove( debug_class_user_selection );\n                }\n\n                if( newUserSelection ) {\n                    newUserSelection.classList.add( debug_class );\n                    newUserSelection.classList.add( debug_class_user_selection );\n                }\n            }\n\n            this._immediateUserSelection = newUserSelection;\n\n            if( this._currentDropTarget !== null ) {\n                this._dragDataStore._mode = DragDataStoreMode.PROTECTED;\n                this._dataTransfer.dropEffect = DROP_EFFECTS[ DROP_EFFECT.NONE ];\n                dispatchDragEvent( \"dragexit\", this._currentDropTarget, this._lastTouchEvent, this._dragDataStore, this._dataTransfer, false );\n            }\n\n            // If the new immediate user selection is null\n            if( this._immediateUserSelection === null ) {\n                //Set the current target element to null also.\n                this._currentDropTarget = this._immediateUserSelection;\n\n                DEBUG && console.log( \"dnd-poly: current drop target changed to null\" );\n            }\n            // THIS IS SKIPPED SINCE SUPPORT IS ONLY AVAILABLE FOR DOM ELEMENTS\n            // If the new immediate user selection is in a non-DOM document or application\n            // else if() {\n            //      Set the current target element to the immediate user selection.\n            //      this.currentDropTarget = this.immediateUserSelection;\n            //      return;\n            // }\n            // Otherwise\n            else {\n                // Fire a DND event named dragenter at the immediate user selection.\n                //the polyfill cannot determine if a handler even exists as browsers do to silently\n                // allow drop when no listener existed, so this event MUST be handled by the client\n                this._dragDataStore._mode = DragDataStoreMode.PROTECTED;\n                this._dataTransfer.dropEffect = determineDropEffect( this._dragDataStore._effectAllowed, this._sourceNode );\n                if( dispatchDragEvent( \"dragenter\", this._immediateUserSelection, this._lastTouchEvent, this._dragDataStore, this._dataTransfer ) ) {\n                    DEBUG && console.log( \"dnd-poly: dragenter default prevented\" );\n                    // If the event is canceled, then set the current target element to the immediate user selection.\n                    this._currentDropTarget = this._immediateUserSelection;\n                    this._currentDragOperation = determineDragOperation( this._dataTransfer.effectAllowed, this._dataTransfer.dropEffect );\n                }\n                // Otherwise, run the appropriate step from the following list:\n                else {\n\n                    // NO DROPZONE SUPPORT SINCE NATIVE IMPLEMENTATIONS IN BROWSERS ALSO DO NOT\n                    //console.log( \"dnd-poly: dragenter not prevented, searching for dropzone..\" );\n                    //var newTarget = DragOperationController.FindDropzoneElement( this.immediateUserSelection );\n\n                    // THIS IS SKIPPED SINCE SUPPORT IS ONLY AVAILABLE FOR DOM ELEMENTS\n                    // If the current target element is a text field (e.g. textarea, or an input element whose type attribute is in the Text state) or an\n                    // editable element, and the drag data store item list has an item with the drag data item type string \"text/plain\" and the drag data\n                    // item kind Plain Unicode string\n                    //if( ElementIsTextDropzone( this.immediateUserSelection, this.dragDataStore ) ) {\n                    //Set the current target element to the immediate user selection anyway.\n                    //this.currentDropTarget = this.immediateUserSelection;\n                    //}\n                    //else\n                    // If the current target element is an element with a dropzone attribute that matches the drag data store\n                    //if( newTarget === this.immediateUserSelection &&\n                    //    DragOperationController.GetOperationForMatchingDropzone( this.immediateUserSelection, this.dragDataStore ) !== \"none\" ) {\n                    // Set the current target element to the immediate user selection anyway.\n                    //    this.currentDropTarget = this.immediateUserSelection;\n                    //}\n                    // If the immediate user selection is an element that itself has an ancestor element\n                    // with a dropzone attribute that matches the drag data store\n                    // NO DROPZONE SUPPORT SINCE NATIVE IMPLEMENTATIONS IN BROWSERS ALSO DO NOT\n                    //else if( newTarget !== null && DragOperationController.GetOperationForMatchingDropzone( newTarget, this.dragDataStore ) ) {\n\n                    // If the immediate user selection is new target, then leave the current target element unchanged.\n\n                    // Otherwise, fire a DND event named dragenter at new target, with the current target element\n                    // as the specific related target. Then, set the current target element to new target,\n                    // regardless of whether that event was canceled or not.\n                    //this.dragenter( newTarget, this.currentDropTarget );\n                    //this.currentDropTarget = newTarget;\n                    //}\n                    // If the current target element is not the body element\n                    //else\n                    if( this._immediateUserSelection !== document.body ) {\n                        // Fire a DND event named dragenter at the body element, and set the current target element to the body element, regardless of\n                        // whether that event was canceled or not.\n                        // Note: If the body element is null, then the event will be fired at the Document object (as\n                        // required by the definition of the body element), but the current target element would be set to null, not the Document object.\n\n                        // We do not listen to what the spec says here because this results in doubled events on the body/document because if the first one\n                        // was not cancelled it will have bubbled up to the body already ;)\n                        //  this.dragenter( window.document.body );\n                        this._currentDropTarget = document.body;\n                    }\n                    // Otherwise\n                    //else {\n                    // leave the current drop target unchanged\n                    //}\n                }\n            }\n        }\n\n        // If the previous step caused the current target element to change,\n        // and if the previous target element was not null or a part of a non-DOM document,\n        // then fire a DND event named dragleave at the previous target element.\n        if( previousTargetElement !== this._currentDropTarget && (isDOMElement( previousTargetElement ) ) ) {\n\n            if( DEBUG ) {\n                previousTargetElement.classList.remove( debug_class_drop_target );\n            }\n\n            DEBUG && console.log( \"dnd-poly: current drop target changed.\" );\n\n            this._dragDataStore._mode = DragDataStoreMode.PROTECTED;\n            this._dataTransfer.dropEffect = DROP_EFFECTS[ DROP_EFFECT.NONE ];\n            dispatchDragEvent( \"dragleave\", previousTargetElement, this._lastTouchEvent, this._dragDataStore, this._dataTransfer, false, this._currentDropTarget );\n        }\n\n        // If the current target element is a DOM element, then fire a DND event named dragover at this current target element.\n        if( isDOMElement( this._currentDropTarget ) ) {\n\n            if( DEBUG ) {\n                this._currentDropTarget.classList.add( debug_class );\n                this._currentDropTarget.classList.add( debug_class_drop_target );\n            }\n\n            // If the dragover event is not canceled, run the appropriate step from the following list:\n            this._dragDataStore._mode = DragDataStoreMode.PROTECTED;\n            this._dataTransfer.dropEffect = determineDropEffect( this._dragDataStore._effectAllowed, this._sourceNode );\n            if( dispatchDragEvent( \"dragover\", this._currentDropTarget, this._lastTouchEvent, this._dragDataStore, this._dataTransfer ) === false ) {\n\n                DEBUG && console.log( \"dnd-poly: dragover not prevented on possible drop-target.\" );\n                // NO DROPZONE SUPPORT SINCE NATIVE IMPLEMENTATIONS IN BROWSERS ALSO DO NOT\n\n                // THIS IS SKIPPED SINCE SUPPORT IS ONLY AVAILABLE FOR DOM ELEMENTS\n                // If the current target element is a text field (e.g. textarea, or an input element whose type attribute is in the Text state) or\n                // an editable element, and the drag data store item list has an item with the drag data item type string \"text/plain\" and the drag\n                // data item kind Plain Unicode string\n                //if( ElementIsTextDropzone( this.currentDropTarget, this.dragDataStore ) ) {\n                // Set the current drag operation to either \"copy\" or \"move\", as appropriate given the platform conventions.\n                //this.currentDragOperation = \"copy\"; //or move. spec says its platform specific behaviour.\n                //}\n                //else {\n                // If the current target element is an element with a dropzone attribute that matches the drag data store\n                //this.currentDragOperation = DragOperationController.GetOperationForMatchingDropzone( this.currentDropTarget, this.dragDataStore );\n                //}\n                // when dragover is not prevented and no dropzones are there, no drag operation\n                this._currentDragOperation = DROP_EFFECTS[ DROP_EFFECT.NONE ];\n            }\n            // Otherwise (if the dragover event is canceled), set the current drag operation based on the values of the effectAllowed and\n            // dropEffect attributes of the DragEvent object's dataTransfer object as they stood after the event dispatch finished\n            else {\n\n                DEBUG && console.log( \"dnd-poly: dragover prevented.\" );\n\n                this._currentDragOperation = determineDragOperation( this._dataTransfer.effectAllowed, this._dataTransfer.dropEffect );\n            }\n        }\n\n        DEBUG && console.log( \"dnd-poly: d'n'd iteration ended. current drag operation: \" + this._currentDragOperation );\n\n        // THIS IS SKIPPED SINCE SUPPORT IS ONLY AVAILABLE FOR DOM ELEMENTS\n        // Otherwise, if the current target element is not a DOM element, use platform-specific mechanisms to determine what drag operation is\n        // being performed (none, copy, link, or move), and set the current drag operation accordingly.\n\n        //Update the drag feedback (e.g. the mouse cursor) to match the current drag operation, as follows:\n        // ---------------------------------------------------------------------------------------------------------\n        // Drag operation   |\tFeedback\n        // \"copy\"\t        |  Data will be copied if dropped here.\n        // \"link\"\t        |  Data will be linked if dropped here.\n        // \"move\"\t        |  Data will be moved if dropped here.\n        // \"none\"\t        |  No operation allowed, dropping here will cancel the drag-and-drop operation.\n        // ---------------------------------------------------------------------------------------------------------\n\n        if( previousDragOperation !== this._currentDragOperation ) {\n            this._dragImage.classList.remove( CLASS_PREFIX + previousDragOperation );\n        }\n\n        const currentDragOperationClass = CLASS_PREFIX + this._currentDragOperation;\n\n        if( this._dragImage.classList.contains( currentDragOperationClass ) === false ) {\n            this._dragImage.classList.add( currentDragOperationClass );\n        }\n    }\n\n    /**\n     * according to https://html.spec.whatwg.org/multipage/interaction.html#drag-and-drop-processing-model\n     */\n    private _dragOperationEnded( state:DragOperationState ):boolean {\n\n        DEBUG && console.log( \"dnd-poly: drag operation end detected with \" + this._currentDragOperation );\n\n        if( DEBUG ) {\n\n            var debug_class_user_selection = CLASS_PREFIX + \"immediate-user-selection\",\n                debug_class_drop_target    = CLASS_PREFIX + \"current-drop-target\";\n\n            if( this._currentDropTarget ) {\n                this._currentDropTarget.classList.remove( debug_class_drop_target );\n\n            }\n            if( this._immediateUserSelection ) {\n                this._immediateUserSelection.classList.remove( debug_class_user_selection );\n            }\n        }\n\n        //var dropped:boolean = undefined;\n\n        // Run the following steps, then stop the drag-and-drop operation:\n\n        // If the current drag operation is \"none\" (no drag operation), or,\n        // if the user ended the drag-and-drop operation by canceling it (e.g. by hitting the Escape key), or\n        // if the current target element is null, then the drag operation failed.\n        const dragFailed = (this._currentDragOperation === DROP_EFFECTS[ DROP_EFFECT.NONE ]\n                            || this._currentDropTarget === null\n                            || state === DragOperationState.CANCELLED);\n        if( dragFailed ) {\n\n            // Run these substeps:\n\n            // Let dropped be false.\n            //dropped = false;\n\n            // If the current target element is a DOM element, fire a DND event named dragleave at it;\n            if( isDOMElement( this._currentDropTarget ) ) {\n                this._dragDataStore._mode = DragDataStoreMode.PROTECTED;\n                this._dataTransfer.dropEffect = DROP_EFFECTS[ DROP_EFFECT.NONE ];\n                dispatchDragEvent( \"dragleave\", this._currentDropTarget, this._lastTouchEvent, this._dragDataStore, this._dataTransfer, false );\n            }\n\n            // THIS IS SKIPPED SINCE SUPPORT IS ONLY AVAILABLE FOR DOM ELEMENTS\n            // otherwise, if it is not null, use platform-specific conventions for drag cancellation.\n            //else if( this.currentDropTarget !== null ) {\n            //}\n        }\n        // Otherwise, the drag operation was as success; run these substeps:\n        else {\n\n            // Let dropped be true.\n            //dropped = true;\n\n            // If the current target element is a DOM element, fire a DND event named drop at it;\n            if( isDOMElement( this._currentDropTarget ) ) {\n\n                // If the event is canceled, set the current drag operation to the value of the dropEffect attribute of the\n                // DragEvent object's dataTransfer object as it stood after the event dispatch finished.\n\n                this._dragDataStore._mode = DragDataStoreMode.READONLY;\n                this._dataTransfer.dropEffect = this._currentDragOperation;\n                if( dispatchDragEvent( \"drop\", this._currentDropTarget, this._lastTouchEvent, this._dragDataStore, this._dataTransfer ) ===\n                    true ) {\n\n                    this._currentDragOperation = this._dataTransfer.dropEffect;\n                }\n                // Otherwise, the event is not canceled; perform the event's default action, which depends on the exact target as follows:\n                else {\n\n                    // THIS IS SKIPPED SINCE SUPPORT IS ONLY AVAILABLE FOR DOM ELEMENTS\n                    // If the current target element is a text field (e.g. textarea, or an input element whose type attribute is in the Text state)\n                    // or an editable element,\n                    // and the drag data store item list has an item with the drag data item type string \"text/plain\"\n                    // and the drag data item kind Plain Unicode string\n                    //if( ElementIsTextDropzone( this.currentDropTarget, this.dragDataStore ) ) {\n                    // Insert the actual data of the first item in the drag data store item list to have a drag data item type string of\n                    // \"text/plain\" and a drag data item kind that is Plain Unicode string into the text field or editable element in a manner\n                    // consistent with platform-specific conventions (e.g. inserting it at the current mouse cursor position, or inserting it at\n                    // the end of the field).\n                    //}\n                    // Otherwise\n                    //else {\n                    // Reset the current drag operation to \"none\".\n                    this._currentDragOperation = DROP_EFFECTS[ DROP_EFFECT.NONE ];\n                    //}\n                }\n            }\n            // THIS IS SKIPPED SINCE SUPPORT IS ONLY AVAILABLE FOR DOM ELEMENTS\n            // otherwise, use platform-specific conventions for indicating a drop.\n            //else {\n            //}\n        }\n\n        return dragFailed;\n\n        // THIS IS SKIPPED SINCE SUPPORT IS ONLY AVAILABLE FOR DOM ELEMENTS\n        //if( this.dragend( this.sourceNode ) ) {\n        //    return;\n        //}\n\n        // Run the appropriate steps from the following list as the default action of the dragend event:\n\n        //if( !dropped ) {\n        //    return;\n        //}\n        // dropped is true\n\n        //if( this.currentDragOperation !== \"move\" ) {\n        //    return;\n        //}\n        //// drag operation is move\n        //\n        //if( ElementIsTextDropzone( this.currentDropTarget ) === false ) {\n        //    return;\n        //}\n        //// element is textfield\n        //\n        //// and the source of the drag-and-drop operation is a selection in the DOM\n        //if( this.sourceNode.nodeType === 1 ) {\n        //    // The user agent should delete the range representing the dragged selection from the DOM.\n        //}\n        //// and the source of the drag-and-drop operation is a selection in a text field\n        //else if( this.sourceNode.nodeType === 3 ) {\n        //    // The user agent should delete the dragged selection from the relevant text field.\n        //}\n        //// Otherwise, The event has no default action.\n    }\n\n    // dispatch dragend event and cleanup drag operation\n    private _finishDragOperation():void {\n        DEBUG && console.log( \"dnd-poly: dragimage snap back transition ended\" );\n\n        // Fire a DND event named dragend at the source node.\n        this._dragDataStore._mode = DragDataStoreMode.PROTECTED;\n        this._dataTransfer.dropEffect = this._currentDragOperation;\n        dispatchDragEvent( \"dragend\", this._sourceNode, this._lastTouchEvent, this._dragDataStore, this._dataTransfer, false );\n\n        // drag operation over and out\n        this._dragOperationState = DragOperationState.ENDED;\n        this._cleanup();\n    }\n\n    //</editor-fold>\n}\n\n//</editor-fold>\n\n//<editor-fold desc=\"DataTransfer/DragDataStore\">\n\n/**\n * Polyfills https://html.spec.whatwg.org/multipage/interaction.html#drag-data-store-mode\n */\nconst enum DragDataStoreMode {\n    _DISCONNECTED, // adding an extra mode here because we need a special state to disconnect the data store from dataTransfer instance\n    READONLY,\n    READWRITE,\n    PROTECTED\n}\n\n/**\n * Polyfills https://html.spec.whatwg.org/multipage/interaction.html#the-drag-data-store\n */\ninterface DragDataStore {\n    _mode:DragDataStoreMode;\n    _data:{[type:string]:any};\n    _types:Array<string>;\n    _effectAllowed:string;\n}\n\n/**\n * Polyfills https://html.spec.whatwg.org/multipage/interaction.html#datatransfer\n * TODO fail with errors when somebody uses it wrong so they know they are doing it wrong?\n */\nclass DataTransfer {\n\n    private _dropEffect:string = DROP_EFFECTS[ DROP_EFFECT.NONE ];\n\n    constructor( private _dataStore:DragDataStore,\n                 private _setDragImageHandler:( image:Element, x:number, y:number ) => void ) {\n    }\n\n    //public get files():FileList {\n    //    return undefined;\n    //}\n    //\n    //public get items():DataTransferItemList {\n    //    return undefined;\n    //}\n\n    public get types():ReadonlyArray<string> {\n        if( this._dataStore._mode !== DragDataStoreMode._DISCONNECTED ) {\n            return Object.freeze( this._dataStore._types );\n        }\n    }\n\n    public setData( type:string, data:string ):void {\n        if( this._dataStore._mode === DragDataStoreMode.READWRITE ) {\n\n            if( type.indexOf( \" \" ) > -1 ) {\n                throw new Error( \"illegal arg: type contains space\" );\n            }\n\n            this._dataStore._data[ type ] = data;\n\n            if( this._dataStore._types.indexOf( type ) === -1 ) {\n                this._dataStore._types.push( type );\n            }\n        }\n    }\n\n    public getData( type:string ):string {\n        if( this._dataStore._mode === DragDataStoreMode.READONLY\n            || this._dataStore._mode === DragDataStoreMode.READWRITE ) {\n            return this._dataStore._data[ type ] || \"\";\n        }\n    }\n\n    public clearData( format?:string ):void {\n        if( this._dataStore._mode === DragDataStoreMode.READWRITE ) {\n            // delete data for format\n            if( format && this._dataStore._data[ format ] ) {\n                delete this._dataStore._data[ format ];\n                var index = this._dataStore._types.indexOf( format );\n                if( index > -1 ) {\n                    this._dataStore._types.splice( index, 1 );\n                }\n                return;\n            }\n            // delete all data\n            this._dataStore._data = {};\n            this._dataStore._types = [];\n        }\n    }\n\n    public setDragImage( image:Element, x:number, y:number ):void {\n        if( this._dataStore._mode === DragDataStoreMode.READWRITE ) {\n            this._setDragImageHandler( image, x, y );\n        }\n    }\n\n    public get effectAllowed() {\n        return this._dataStore._effectAllowed;\n    }\n\n    public set effectAllowed( value ) {\n        if( this._dataStore._mode === DragDataStoreMode.READWRITE\n            && ALLOWED_EFFECTS.indexOf( value ) > -1 ) {\n            this._dataStore._effectAllowed = value;\n        }\n    }\n\n    public get dropEffect() {\n        return this._dropEffect;\n    }\n\n    public set dropEffect( value ) {\n        if( this._dataStore._mode !== DragDataStoreMode._DISCONNECTED\n            && ALLOWED_EFFECTS.indexOf( value ) > -1 ) {\n            this._dropEffect = value;\n        }\n    }\n}\n\n//</editor-fold>\n\n//<editor-fold desc=\"util\">\n\nexport interface Point {\n    x:number;\n    y:number;\n}\n\nfunction addDocumentListener( ev:string, handler:EventListener, passive:boolean = true ) {\n    (document.addEventListener as WhatWGAddEventListener)( ev, handler, supportsPassive ? { passive:passive } : false );\n}\n\nfunction removeDocumentListener( ev:string, handler:EventListener ) {\n    document.removeEventListener( ev, handler );\n}\n\nfunction average( array:Array<number> ) {\n    if( array.length === 0 ) {\n        return 0;\n    }\n    return array.reduce( (function( s, v ) {\n            return v + s;\n        }), 0 ) / array.length;\n}\n\nfunction isDOMElement( object:any ) {\n    return object && object.tagName;\n}\n\nfunction isTouchIdentifierContainedInTouchEvent( newTouch:TouchEvent, touchIdentifier:number ) {\n    for( let i = 0; i < newTouch.changedTouches.length; i++ ) {\n        const touch = newTouch.changedTouches[ i ];\n        if( touch.identifier === touchIdentifier ) {\n            return true;\n        }\n    }\n    return false;\n}\n\nfunction createDragEventFromTouch( targetElement:Element,\n                                   e:TouchEvent,\n                                   type:string,\n                                   cancelable:boolean,\n                                   window:Window,\n                                   dataTransfer:DataTransfer,\n                                   relatedTarget:Element = null ) {\n\n    const touch:Touch = e.changedTouches[ 0 ];\n\n    const dndEvent:DragEvent = <DragEvent>new Event( type, {\n        bubbles: true,\n        cancelable: cancelable\n    } );\n\n    // cast our polyfill\n    (dndEvent as any).dataTransfer = <any>dataTransfer;\n    (dndEvent as any).relatedTarget = relatedTarget;\n\n    // set the coordinates\n    (dndEvent as any).screenX = touch.screenX;\n    (dndEvent as any).screenY = touch.screenY;\n    (dndEvent as any).clientX = touch.clientX;\n    (dndEvent as any).clientY = touch.clientY;\n    (dndEvent as any).pageX = touch.pageX;\n    (dndEvent as any).pageY = touch.pageY;\n\n    const targetRect = targetElement.getBoundingClientRect();\n    (dndEvent as any).offsetX = dndEvent.clientX - targetRect.left;\n    (dndEvent as any).offsetY = dndEvent.clientY - targetRect.top;\n\n    return dndEvent;\n}\n\n/**\n * Calc center of polygon spanned by multiple touches in page (full page size, with hidden scrollable area) coordinates\n * or in viewport (screen coordinates) coordinates.\n */\nfunction updateCentroidCoordinatesOfTouchesIn( coordinateProp:string, event:TouchEvent, outPoint:Point ):void {\n    const pageXs:Array<number> = [], pageYs:Array<number> = [];\n    for( let i = 0; i < event.touches.length; i++ ) {\n        const touch = event.touches[ i ];\n        pageXs.push( touch[ coordinateProp + \"X\" ] );\n        pageYs.push( touch[ coordinateProp + \"Y\" ] );\n    }\n    outPoint.x = average( pageXs );\n    outPoint.y = average( pageYs );\n}\n\nfunction prepareNodeCopyAsDragImage( srcNode:HTMLElement, dstNode:HTMLElement ) {\n    // Is this node an element?\n    if( srcNode.nodeType === 1 ) {\n\n        // Clone the style\n        const cs = getComputedStyle( srcNode );\n        for( let i = 0; i < cs.length; i++ ) {\n            const csName = cs[ i ];\n            dstNode.style.setProperty( csName, cs.getPropertyValue( csName ), cs.getPropertyPriority( csName ) );\n        }\n\n        // no interaction with the drag image, pls! this is also important to make the drag image transparent for hit-testing\n        // hit testing is done in the drag and drop iteration to find the element the user currently is hovering over while dragging.\n        // if pointer-events is not none or a browser does behave in an unexpected way than the hit test transparency on the drag image\n        // will break\n        dstNode.style.pointerEvents = \"none\";\n\n        // Remove any potential conflict attributes\n        dstNode.removeAttribute( \"id\" );\n        dstNode.removeAttribute( \"class\" );\n        dstNode.removeAttribute( \"draggable\" );\n    }\n\n    // Do the same for the children\n    if( srcNode.hasChildNodes() ) {\n        for( let i = 0; i < srcNode.childNodes.length; i++ ) {\n            prepareNodeCopyAsDragImage( <HTMLElement>srcNode.childNodes[ i ], <HTMLElement>dstNode.childNodes[ i ] );\n        }\n    }\n}\n\nfunction createDragImage( sourceNode:HTMLElement ):HTMLElement {\n\n    const dragImage = <HTMLElement>sourceNode.cloneNode( true );\n\n    // this removes any id's and stuff that could interfere with drag and drop\n    prepareNodeCopyAsDragImage( sourceNode, dragImage );\n\n    // set layout styles for freely moving it around\n    dragImage.style.position = \"absolute\";\n    dragImage.style.left = \"0px\";\n    dragImage.style.top = \"0px\";\n    // on top of all\n    dragImage.style.zIndex = \"999999\";\n\n    // add polyfill class for default styling\n    dragImage.classList.add( CLASS_DRAG_IMAGE );\n    dragImage.classList.add( CLASS_DRAG_OPERATION_ICON );\n\n    return dragImage;\n}\n\nfunction extractTransformStyles( sourceNode:HTMLElement ):string[] {\n\n    return TRANSFORM_CSS_VENDOR_PREFIXES.map( function( prefix ) {\n\n        let transform = sourceNode.style[ prefix + \"transform\" ];\n\n        if( !transform || transform === \"none\" ) {\n            return \"\";\n        }\n\n        // TODO what about translateX(x), translateY(x), translateZ(z), translate3d(x,y,z), matrix(*,*,*,*,x,y) ?\n\n        // removes translate(x,y)\n        return transform.replace( /translate\\(\\D*\\d+[^,]*,\\D*\\d+[^,]*\\)\\s*/g, \"\" );\n    } );\n}\n\nfunction translateDragImage( dragImage:HTMLElement, pnt:Point, originalTransforms:string[], offset?:Point, centerOnCoordinates = true ):void {\n\n    let x = pnt.x, y = pnt.y;\n\n    if( offset ) {\n        x += offset.x;\n        y += offset.y;\n    }\n\n    if( centerOnCoordinates ) {\n        x -= (parseInt( <any>dragImage.offsetWidth, 10 ) / 2);\n        y -= (parseInt( <any>dragImage.offsetHeight, 10 ) / 2);\n    }\n\n    // using translate3d for best performance\n    const translate = \"translate3d(\" + x + \"px,\" + y + \"px, 0)\";\n\n    for( let i = 0; i < TRANSFORM_CSS_VENDOR_PREFIXES.length; i++ ) {\n        const transformProp = TRANSFORM_CSS_VENDOR_PREFIXES[ i ] + \"transform\";\n        dragImage.style[ transformProp ] = translate + \" \" + originalTransforms[ i ];\n    }\n}\n\n/**\n * calculates the coordinates of the drag source and transitions the drag image to those coordinates.\n * the drag operation is finished after the transition has ended.\n */\nfunction applyDragImageSnapback( sourceEl:HTMLElement, dragImage:HTMLElement, dragImageTransforms:string[], transitionEndCb:Function ):void {\n\n    const cs = getComputedStyle( sourceEl );\n\n    if( cs.visibility === \"hidden\" || cs.display === \"none\" ) {\n        DEBUG && console.log( \"dnd-poly: source node is not visible. skipping snapback transition.\" );\n        // shortcut to end the drag operation\n        transitionEndCb();\n        return;\n    }\n\n    DEBUG && console.log( \"dnd-poly: starting dragimage snap back\" );\n\n    // calc source node position\n    const rect = sourceEl.getBoundingClientRect();\n\n    const pnt:Point = {\n        x: rect.left,\n        y: rect.top\n    };\n\n    // add scroll offset of document\n    pnt.x += (document.body.scrollLeft || document.documentElement.scrollLeft);\n    pnt.y += (document.body.scrollTop || document.documentElement.scrollTop);\n\n    //TODO this sometimes fails.. find out when exactly and how to detect\n    pnt.x -= parseInt( cs.marginLeft, 10 );\n    pnt.y -= parseInt( cs.marginTop, 10 );\n\n    // add class containing transition rules\n    dragImage.classList.add( CLASS_DRAG_IMAGE_SNAPBACK );\n\n    const csDragImage = getComputedStyle( dragImage );\n    const durationInS = parseFloat( csDragImage.transitionDuration );\n    const delayInS = parseFloat( csDragImage.transitionDelay );\n    const durationInMs = Math.round( (durationInS + delayInS) * 1000 );\n\n    // apply the translate\n    translateDragImage( dragImage, pnt, dragImageTransforms, undefined, false );\n\n    setTimeout( transitionEndCb, durationInMs );\n}\n\n//</editor-fold>\n\n//<editor-fold desc=\"dnd spec util\">\n\n/**\n * Implements \"6.\" in the processing steps defined for a dnd event\n * https://html.spec.whatwg.org/multipage/interaction.html#dragevent\n */\nfunction determineDropEffect( effectAllowed:string, sourceNode:Element ) {\n\n    // uninitialized\n    if( !effectAllowed ) {\n\n        // THIS IS SKIPPED SINCE SUPPORT IS ONLY AVAILABLE FOR DOM ELEMENTS\n        //if( sourceNode.nodeType === 1 ) {\n        //\n        //return \"move\";\n        //}\n\n        // link\n        if( sourceNode.nodeType === 3 && (<HTMLElement>sourceNode).tagName === \"A\" ) {\n            return DROP_EFFECTS[ DROP_EFFECT.LINK ];\n        }\n\n        // copy\n        return DROP_EFFECTS[ DROP_EFFECT.COPY ];\n    }\n\n    // none\n    if( effectAllowed === ALLOWED_EFFECTS[ EFFECT_ALLOWED.NONE ] ) {\n        return DROP_EFFECTS[ DROP_EFFECT.NONE ];\n    }\n    // copy or all\n    if( effectAllowed.indexOf( ALLOWED_EFFECTS[ EFFECT_ALLOWED.COPY ] ) === 0 || effectAllowed === ALLOWED_EFFECTS[ EFFECT_ALLOWED.ALL ] ) {\n        return DROP_EFFECTS[ DROP_EFFECT.COPY ];\n    }\n    // link\n    if( effectAllowed.indexOf( ALLOWED_EFFECTS[ EFFECT_ALLOWED.LINK ] ) === 0 ) {\n        return DROP_EFFECTS[ DROP_EFFECT.LINK ];\n    }\n    // move\n    if( effectAllowed === ALLOWED_EFFECTS[ EFFECT_ALLOWED.MOVE ] ) {\n        return DROP_EFFECTS[ DROP_EFFECT.MOVE ];\n    }\n\n    // copy\n    return DROP_EFFECTS[ DROP_EFFECT.COPY ];\n}\n\n/**\n * Reference https://html.spec.whatwg.org/multipage/interaction.html#dndevents\n */\nfunction dispatchDragEvent( dragEvent:string,\n                            targetElement:Element,\n                            touchEvent:TouchEvent,\n                            dataStore:DragDataStore,\n                            dataTransfer:DataTransfer,\n                            cancelable = true,\n                            relatedTarget:Element = null ):boolean {\n\n    DEBUG && console.log( \"dnd-poly: dispatching \" + dragEvent );\n\n    if( DEBUG ) {\n        var debug_class                      = CLASS_PREFIX + \"debug\",\n            debug_class_event_target         = CLASS_PREFIX + \"event-target\",\n            debug_class_event_related_target = CLASS_PREFIX + \"event-related-target\";\n        targetElement.classList.add( debug_class );\n        targetElement.classList.add( debug_class_event_target );\n        if( relatedTarget ) {\n            relatedTarget.classList.add( debug_class );\n            relatedTarget.classList.add( debug_class_event_related_target );\n        }\n    }\n\n    const leaveEvt = createDragEventFromTouch( targetElement, touchEvent, dragEvent, cancelable, document.defaultView, dataTransfer, relatedTarget );\n    const cancelled = !targetElement.dispatchEvent( leaveEvt );\n\n    dataStore._mode = DragDataStoreMode._DISCONNECTED;\n\n    if( DEBUG ) {\n        targetElement.classList.remove( debug_class_event_target );\n        if( relatedTarget ) {\n            relatedTarget.classList.remove( debug_class_event_related_target );\n        }\n    }\n\n    return cancelled;\n}\n\n/**\n * according to https://html.spec.whatwg.org/multipage/interaction.html#drag-and-drop-processing-model\n */\nfunction determineDragOperation( effectAllowed:string, dropEffect:string ):string {\n\n    // unitialized or all\n    if( !effectAllowed || effectAllowed === ALLOWED_EFFECTS[ 7 ] ) {\n        return dropEffect;\n    }\n\n    if( dropEffect === DROP_EFFECTS[ DROP_EFFECT.COPY ] ) {\n        if( effectAllowed.indexOf( DROP_EFFECTS[ DROP_EFFECT.COPY ] ) === 0 ) {\n            return DROP_EFFECTS[ DROP_EFFECT.COPY ];\n        }\n    }\n    else if( dropEffect === DROP_EFFECTS[ DROP_EFFECT.LINK ] ) {\n        if( effectAllowed.indexOf( DROP_EFFECTS[ DROP_EFFECT.LINK ] ) === 0 || effectAllowed.indexOf( \"Link\" ) > -1 ) {\n            return DROP_EFFECTS[ DROP_EFFECT.LINK ];\n        }\n    }\n    else if( dropEffect === DROP_EFFECTS[ DROP_EFFECT.MOVE ] ) {\n        if( effectAllowed.indexOf( DROP_EFFECTS[ DROP_EFFECT.MOVE ] ) === 0 || effectAllowed.indexOf( \"Move\" ) > -1 ) {\n            return DROP_EFFECTS[ DROP_EFFECT.MOVE ];\n        }\n    }\n\n    return DROP_EFFECTS[ DROP_EFFECT.NONE ];\n}\n\n//</editor-fold>\n\n//<editor-fold desc=\"dead dnd spec code\">\n\n/**\n * // THIS IS SKIPPED SINCE SUPPORT IS ONLY AVAILABLE FOR DOM ELEMENTS\n */\n//public static ElementIsTextDropzone( element:HTMLElement, dragDataStore?:DragDataStore ) {\n//\n//    if( dragDataStore && !dragDataStore.data[ \"text/plain\" ] ) {\n//        return false;\n//    }\n//\n//    if( element.isContentEditable ) {\n//        return true;\n//    }\n//\n//    if( element.tagName === \"TEXTAREA\" ) {\n//        return true;\n//    }\n//\n//    if( element.tagName === \"INPUT\" ) {\n//        if( element.getAttribute( \"type\" ) === \"text\" ) {\n//            return true;\n//        }\n//    }\n//\n//    return false;\n//}\n\n/**\n * NO DROPZONE SUPPORT SINCE NATIVE IMPLEMENTATIONS IN BROWSERS ALSO DO NOT\n *\n * Helper method for recursively go from a nested element up the ancestor chain\n * to see if any element has a dropzone.\n */\n//private static FindDropzoneElement( element:HTMLElement ):HTMLElement {\n//\n//    if( !element || !element.hasAttribute || typeof element.hasAttribute !== \"function\" ) {\n//        return null;\n//    }\n//\n//    if( element.hasAttribute( \"dropzone\" ) ) {\n//        return element;\n//    }\n//\n//    if( element === window.document.body ) {\n//        return null;\n//    }\n//\n//    return DragOperationController.FindDropzoneElement( element.parentElement );\n//}\n\n/**\n * NO DROPZONE SUPPORT SINCE NATIVE IMPLEMENTATIONS IN BROWSERS ALSO DO NOT\n *\n * Polyfills https://html.spec.whatwg.org/multipage/interaction.html#the-dropzone-attribute\n * by implementing the dropzone processing steps.\n */\n//private static GetOperationForMatchingDropzone( element:HTMLElement, dragDataStore:DragDataStore ):string {\n\n// If the current target element is an element with a dropzone attribute that matches the drag data store and specifies an operation\n//      Set the current drag operation to the operation specified by the dropzone attribute of the current target element.\n// If the current target element is an element with a dropzone attribute that matches the drag data store and does not specify an operation\n//      Set the current drag operation to \"copy\".\n// Otherwise\n//      Reset the current drag operation to \"none\".\n//var value = element.getAttribute( \"dropzone\" );\n//if( !value ) {\n//\n//    return \"none\";\n//}\n//\n//var matched = false;\n//var operation;\n//var keywords = value.split( \" \" );\n//\n//for( var i:number = 0; i < keywords.length; i++ ) {\n//    var keyword = keywords[ i ];\n//\n//    if( keyword === \"copy\" || keyword === \"move\" || keyword === \"link\" ) {\n//        if( !operation ) {\n//            operation = keyword;\n//        }\n//        continue;\n//    }\n//\n//    if( keyword.length < 3 || keyword[ 1 ] !== \":\" ) {\n//        continue;\n//    }\n//\n//    var splitKeyword = keyword.split( \":\" );\n//    var kind = splitKeyword[ 0 ].toLowerCase();\n//    var type = splitKeyword[ 1 ].toLowerCase();\n//\n//    if( dragDataStore.types.indexOf( type ) > -1 ) {\n//        matched = true;\n//    }\n//}\n//\n//if( !matched ) {\n//    return \"none\";\n//}\n//\n//if( !operation ) {\n//    return \"copy\";\n//}\n//\n//return operation;\n//}\n\n//</editor-fold>\n\nexport const DragDropPolyfill = {\n    DEBUG: DEBUG,\n    Initialize: Initialize\n};\n\n","import { DragDropPolyfill as polyfill, Point, DragImageTranslateOverrideFn, Config } from \"./drag-drop-polyfill.js\";\n\ndeclare let config: Config; // Silence lint warning about unused Config import\n\nlet _options:ScrollOptions = {\n    threshold: 75,\n    // simplified cubic-ease-in function\n    velocityFn: function( velocity:number, threshold:number ) {\n        const multiplier = velocity / threshold;\n        const easeInCubic = multiplier * multiplier * multiplier;\n        return easeInCubic * threshold;\n    }\n};\n\nlet _scrollIntentions:ScrollIntentions = {\n    horizontal: ScrollIntention.NONE,\n    vertical: ScrollIntention.NONE\n};\n\nlet _dynamicVelocity:Point = {\n    x: 0,\n    y: 0\n};\n\nlet _scrollAnimationFrameId:any;\nlet _currentCoordinates:Point;\nlet _hoveredElement:HTMLElement;\nlet _scrollableParent:HTMLElement;\nlet _translateDragImageFn:( offsetX:number, offsetY:number ) => void;\n\n/**\n * core handler function\n */\nfunction handleDragImageTranslateOverride( event:TouchEvent,\n                                           currentCoordinates:Point,\n                                           hoveredElement:HTMLElement,\n                                           translateDragImageFn:( scrollDiffX:number, scrollDiffY:number ) => void ):void {\n\n    _currentCoordinates = currentCoordinates;\n    _translateDragImageFn = translateDragImageFn;\n\n    // update parent if hovered element changed\n    if( _hoveredElement !== hoveredElement ) {\n\n        _hoveredElement = hoveredElement;\n        _scrollableParent = findScrollableParent( _hoveredElement );\n    }\n\n    // update scroll intention and check if we should scroll at all\n    //TODO implement scroll chaining? if scroll end is reached continue to look for scrollable parent\n    const performScrollAnimation = updateScrollIntentions( _currentCoordinates, _scrollableParent, _options.threshold, _scrollIntentions, _dynamicVelocity );\n\n    // no animation in progress but scroll is intended\n    if( performScrollAnimation ) {\n\n        // setup scroll animation frame\n        scheduleScrollAnimation();\n    }\n    else if( !!_scrollAnimationFrameId ) {\n\n        window.cancelAnimationFrame( _scrollAnimationFrameId );\n        _scrollAnimationFrameId = null;\n    }\n}\n\n//<editor-fold desc=\"programmatic scroll animation frame handler\">\n\nfunction scheduleScrollAnimation() {\n\n    // prevent scheduling when already scheduled\n    if( !!_scrollAnimationFrameId ) {\n\n        return;\n    }\n\n    _scrollAnimationFrameId = window.requestAnimationFrame( scrollAnimation );\n}\n\nfunction scrollAnimation() {\n\n    let scrollDiffX = 0,\n        scrollDiffY = 0,\n        isTopLevel  = isTopLevelEl( _scrollableParent );\n\n    if( _scrollIntentions.horizontal !== ScrollIntention.NONE ) {\n\n        scrollDiffX = Math.round( _options.velocityFn( _dynamicVelocity.x, _options.threshold ) * _scrollIntentions.horizontal );\n        getSetElementScroll( _scrollableParent, ScrollAxis.HORIZONTAL, scrollDiffX );\n    }\n\n    if( _scrollIntentions.vertical !== ScrollIntention.NONE ) {\n\n        scrollDiffY = Math.round( _options.velocityFn( _dynamicVelocity.y, _options.threshold ) * _scrollIntentions.vertical );\n        getSetElementScroll( _scrollableParent, ScrollAxis.VERTICAL, scrollDiffY );\n    }\n\n    if( isTopLevel ) {\n        // on top level element scrolling we need to translate the drag image as much as we scroll\n        _translateDragImageFn( scrollDiffX, scrollDiffY );\n    }\n    else {\n        // just scroll the container and update the drag image position without offset\n        _translateDragImageFn( 0, 0 );\n    }\n\n    // reset to make sure we can re-schedule scroll animation\n    _scrollAnimationFrameId = null;\n\n    // check if we should continue scrolling\n    //TODO implement scroll chaining? if scroll end is reached continue to look for scrollable parent\n    if( updateScrollIntentions( _currentCoordinates, _scrollableParent, _options.threshold, _scrollIntentions, _dynamicVelocity ) ) {\n\n        // re-schedule animation frame callback\n        scheduleScrollAnimation();\n    }\n}\n\n//</editor-fold>\n\n//<editor-fold desc=\"scroll checks\">\n\nfunction updateScrollIntentions( currentCoordinates:Point,\n                                 scrollableParent:HTMLElement,\n                                 threshold:number,\n                                 scrollIntentions:ScrollIntentions,\n                                 dynamicVelocity:Point ):boolean {\n\n    if( !currentCoordinates || !scrollableParent ) {\n\n        // when coordinates become undefined drag operation stopped. stop scrolling also.\n        return false;\n    }\n\n    const scrollableParentBounds:IScrollBounds = {\n        x: getElementViewportOffset( scrollableParent, ScrollAxis.HORIZONTAL ),\n        y: getElementViewportOffset( scrollableParent, ScrollAxis.VERTICAL ),\n        width: getElementViewportSize( scrollableParent, ScrollAxis.HORIZONTAL ),\n        height: getElementViewportSize( scrollableParent, ScrollAxis.VERTICAL ),\n        scrollX: getSetElementScroll( scrollableParent, ScrollAxis.HORIZONTAL ),\n        scrollY: getSetElementScroll( scrollableParent, ScrollAxis.VERTICAL ),\n        scrollWidth: scrollableParent.scrollWidth,\n        scrollHeight: scrollableParent.scrollHeight\n    };\n\n    const currentCoordinatesOffset = {\n        x: currentCoordinates.x - scrollableParentBounds.x,\n        y: currentCoordinates.y - scrollableParentBounds.y\n    };\n\n    scrollIntentions.horizontal = determineScrollIntention( currentCoordinatesOffset.x, scrollableParentBounds.width, threshold );\n    scrollIntentions.vertical = determineScrollIntention( currentCoordinatesOffset.y, scrollableParentBounds.height, threshold );\n\n    if( scrollIntentions.horizontal && isScrollEndReached( ScrollAxis.HORIZONTAL, scrollIntentions.horizontal, scrollableParentBounds ) ) {\n\n        // if scroll end is reached, reset to none\n        scrollIntentions.horizontal = ScrollIntention.NONE;\n    }\n    else if( scrollIntentions.horizontal ) {\n\n        dynamicVelocity.x = determineDynamicVelocity( scrollIntentions.horizontal, currentCoordinatesOffset.x, scrollableParentBounds.width, threshold );\n    }\n\n    if( scrollIntentions.vertical && isScrollEndReached( ScrollAxis.VERTICAL, scrollIntentions.vertical, scrollableParentBounds ) ) {\n\n        // if scroll end is reached, reset to none\n        scrollIntentions.vertical = ScrollIntention.NONE;\n    }\n    else if( scrollIntentions.vertical ) {\n\n        dynamicVelocity.y = determineDynamicVelocity( scrollIntentions.vertical, currentCoordinatesOffset.y, scrollableParentBounds.height, threshold );\n    }\n\n    return !!(scrollIntentions.horizontal || scrollIntentions.vertical);\n}\n\n//</editor-fold>\n\n//<editor-fold desc=\"static scroll utils\">\n\ninterface ScrollIntentions {\n    horizontal:ScrollIntention;\n    vertical:ScrollIntention;\n}\n\ninterface IScrollBounds {\n    x:number;\n    y:number;\n    width:number;\n    height:number;\n    scrollX:number;\n    scrollY:number;\n    scrollHeight:number;\n    scrollWidth:number;\n}\n\nconst enum ScrollIntention {\n    NONE            = 0,\n    LEFT_OR_TOP     = -1,\n    RIGHT_OR_BOTTOM = 1\n}\n\nconst enum ScrollAxis {\n    HORIZONTAL,\n    VERTICAL\n}\n\nfunction isTopLevelEl( el:HTMLElement ):boolean {\n\n    return (el === document.body || el === document.documentElement);\n}\n\nfunction getElementViewportOffset( el:HTMLElement, axis:ScrollAxis ) {\n    let offset:number;\n\n    if( isTopLevelEl( el ) ) {\n        offset = (axis === ScrollAxis.HORIZONTAL) ? el.clientLeft : el.clientTop;\n    }\n    else {\n        const bounds = el.getBoundingClientRect();\n        offset = (axis === ScrollAxis.HORIZONTAL) ? bounds.left : bounds.top;\n    }\n\n    return offset;\n}\n\nfunction getElementViewportSize( el:HTMLElement, axis:ScrollAxis ) {\n    let size:number;\n\n    if( isTopLevelEl( el ) ) {\n        size = (axis === ScrollAxis.HORIZONTAL) ? window.innerWidth : window.innerHeight;\n    }\n    else {\n        size = (axis === ScrollAxis.HORIZONTAL) ? el.clientWidth : el.clientHeight;\n    }\n\n    return size;\n}\n\nfunction getSetElementScroll( el:HTMLElement, axis:ScrollAxis, scroll?:number ) {\n    const prop = (axis === ScrollAxis.HORIZONTAL) ? \"scrollLeft\" : \"scrollTop\";\n\n    // abstracting away compatibility issues on scroll properties of document/body\n    const isTopLevel = isTopLevelEl( el );\n\n    if( arguments.length === 2 ) {\n\n        if( isTopLevel ) {\n            return document.body[ prop ] || document.documentElement[ prop ];\n        }\n\n        return el[ prop ];\n    }\n\n    if( isTopLevel ) {\n        document.documentElement[ prop ] += scroll;\n        document.body[ prop ] += scroll;\n    }\n    else {\n        el[ prop ] += scroll;\n    }\n}\n\n//TODO check if scroll end is reached according to scroll intention? this is needed to implement scroll chaining\nfunction isScrollable( el:HTMLElement ):boolean {\n    const cs = getComputedStyle( el );\n\n    if( el.scrollHeight > el.clientHeight && (cs.overflowY === \"scroll\" || cs.overflowY === \"auto\") ) {\n        return true;\n    }\n\n    if( el.scrollWidth > el.clientWidth && (cs.overflowX === \"scroll\" || cs.overflowX === \"auto\") ) {\n        return true;\n    }\n\n    return false;\n}\n\nfunction findScrollableParent( el:HTMLElement ):HTMLElement {\n    do {\n        if( !el ) {\n            return undefined;\n        }\n        if( isScrollable( el ) ) {\n            return el;\n        }\n        if( el === document.documentElement ) {\n            return null;\n        }\n    } while( el = <HTMLElement>el.parentNode );\n    return null;\n}\n\nfunction determineScrollIntention( currentCoordinate:number, size:number, threshold:number ):ScrollIntention {\n\n    // LEFT / TOP\n    if( currentCoordinate < threshold ) {\n        return ScrollIntention.LEFT_OR_TOP;\n    }\n    // RIGHT / BOTTOM\n    else if( size - currentCoordinate < threshold ) {\n        return ScrollIntention.RIGHT_OR_BOTTOM;\n    }\n    // NONE\n    return ScrollIntention.NONE;\n}\n\nfunction determineDynamicVelocity( scrollIntention:ScrollIntention, currentCoordinate:number, size:number, threshold:number ):number {\n\n    if( scrollIntention === ScrollIntention.LEFT_OR_TOP ) {\n\n        return Math.abs( currentCoordinate - threshold );\n    }\n    else if( scrollIntention === ScrollIntention.RIGHT_OR_BOTTOM ) {\n\n        return Math.abs( size - currentCoordinate - threshold );\n    }\n\n    return 0;\n}\n\nfunction isScrollEndReached( axis:ScrollAxis, scrollIntention:ScrollIntention, scrollBounds:IScrollBounds ) {\n\n    const currentScrollOffset = (axis === ScrollAxis.HORIZONTAL) ? (scrollBounds.scrollX) : (scrollBounds.scrollY);\n\n    // wants to scroll to the right/bottom\n    if( scrollIntention === ScrollIntention.RIGHT_OR_BOTTOM ) {\n\n        const maxScrollOffset = (axis === ScrollAxis.HORIZONTAL) ? ( scrollBounds.scrollWidth - scrollBounds.width ) : ( scrollBounds.scrollHeight -\n                                                                                                                         scrollBounds.height );\n\n        // is already at the right/bottom edge\n        return currentScrollOffset >= maxScrollOffset;\n    }\n    // wants to scroll to the left/top\n    else if( scrollIntention === ScrollIntention.LEFT_OR_TOP ) {\n\n        // is already at left/top edge\n        return (currentScrollOffset <= 0);\n    }\n    // no scroll\n    return true;\n}\n\n//</editor-fold>\n\n//<editor-fold desc=\"public api\">\n\nexport interface ScrollOptions {\n    // threshold in px. when distance between scrollable element edge and touch position is smaller start programmatic scroll.\n    // defaults to 75px\n    threshold?:number;\n    // function to customize the scroll velocity\n    // velocity param: distance to scrollable element edge\n    // threshold: the threshold used to determine when scrolling should start\n    // defaults to cubic-ease-in.\n    velocityFn:( velocity:number, threshold:number ) => number;\n}\n\nfunction SetOptions( options:ScrollOptions ):void {\n\n    // overwrite defaults with input options\n    Object.keys( options ).forEach( function( key ) {\n        _options[ key ] = options[ key ];\n    } );\n}\n\nexport const HandleDragImageTranslateOverride:DragImageTranslateOverrideFn = handleDragImageTranslateOverride;\n\n//</editor-fold>\n\n\nexport const DragDropPolyfill = {\n    DEBUG: polyfill.DEBUG,\n    Initialize: polyfill.Initialize,\n    SetOptions: SetOptions\n};\n"],"names":["DragDropPolyfill","polyfill"],"mappings":"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"}